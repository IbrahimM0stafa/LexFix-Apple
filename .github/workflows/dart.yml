# .github/workflows/dart.yml
name: CI

################################################################################
# Triggers                                                                     #
################################################################################
on:
  push:
    branches: [ main ]              # add other branch names if you use them
    paths:
      - '**/*.dart'
      - pubspec.yaml
  pull_request:
    paths:
      - '**/*.dart'
      - pubspec.yaml
  workflow_dispatch:                # provides the â€œRun workflowâ€ button

################################################################################
# Job 1 â€“ lint & tests (only on push / PR)                                     #
################################################################################
jobs:
  analyze_and_test:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/cirruslabs/flutter:stable   # Flutter stable SDK pre-installed

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install dependencies
        run: flutter pub get

      - name: Static analysis
        run: flutter analyze --no-fatal-on-hints

      - name: Run tests
        run: flutter test

################################################################################
# Job 2 â€“ iOS unsigned IPA (only when you press the button)                    #
################################################################################
  build_ios:
    if: github.event_name == 'workflow_dispatch'
    runs-on: macos-latest

    steps:
      # 1 â”€ Checkout
      - uses: actions/checkout@v3

      # 2 â”€ Flutter toolchain
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          architecture: x64

      # 3 â”€ Clean & get packages
      - name: Flutter clean / pub get
        run: |
          flutter clean
          flutter pub get
        working-directory: mobileapp

      # 4 â”€ Reset Pods and enforce iOS 13
      - name: Prepare iOS folder
        run: |
          cd ios
          rm -rf Pods Podfile.lock
          [ -f Podfile ] || pod init
          if grep -q "^platform :ios" Podfile; then
            sed -i '' "s/^platform :ios.*/platform :ios, '13.0'/" Podfile
          else
            sed -i '' '1s/^/platform :ios, '\''13.0'\''\n/' Podfile
          fi
        working-directory: mobileapp

      # 5 â”€ Patch Podfile for static frameworks, modular headers, Swift 5.9
      - name: Patch Podfile
        run: |
          cd mobileapp/ios
          # force static linkage
          if grep -q "use_frameworks!" Podfile; then
            sed -i '' "s/use_frameworks!.*/use_frameworks! :linkage => :static/" Podfile
          else
            sed -i '' "/target 'Runner' do/a\\
  use_frameworks! :linkage => :static" Podfile
          fi
          # add modular headers if missing
          grep -q "use_modular_headers!" Podfile || \
            sed -i '' "/use_frameworks! :linkage => :static/a\\
  use_modular_headers!" Podfile
          # replace any existing post_install
          sed -i '' '/post_install do/,/^end$/d' Podfile
          cat >> Podfile <<'RUBY'
post_install do |installer|
  installer.pods_project.targets.each do |t|
    t.build_configurations.each do |c|
      c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      c.build_settings['SWIFT_VERSION']              = '5.9'
    end
  end
end
RUBY
          echo "=== Final Podfile ==="
          cat Podfile

      # 6 â”€ Install pods
      - run: pod install --repo-update
        working-directory: mobileapp/ios

      # 7 â”€ Build unsigned IPA
      - run: flutter build ios --release --no-codesign
        working-directory: mobileapp

      # 8 â”€ Package Runner.app â†’ IPA
      - name: Package IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r FlutterIpaExport.ipa Payload
        working-directory: mobileapp

      # 9 â”€ Attach IPA to a GitHub Release
      - name: Upload IPA to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mobileapp/build/ios/iphoneos/FlutterIpaExport.ipa
          asset_name: FlutterIpaExport.ipa
          tag: ios-build-${{ github.run_number }}
          overwrite: true
          body: |
            ðŸŽ‰ Unsigned iOS IPA for run #${{ github.run_number }}
