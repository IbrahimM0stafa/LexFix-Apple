name: iOS-ipa-build
on:
  workflow_dispatch:
jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          architecture: x64
      
      # Clean workspace
      - run: flutter clean
        working-directory: mobileapp
      
      # Get dependencies (creates pubspec.lock)
      - run: flutter pub get
        working-directory: mobileapp
      
      # Fix compatibility issues
      - name: Resolve Firebase conflicts
        run: |
          cd mobileapp
          
          # Update to compatible versions
          flutter pub add \
            firebase_core:^2.32.0 \
            firebase_messaging:^14.7.10 \
            cloud_firestore:^4.15.2 \
            firebase_auth:^4.11.1 \
            google_sign_in:^6.1.14
          
          # Force GoogleUtilities resolution
          echo "Adding Podfile resolution rules..."
          cat << EOF > ios/Podfile
          platform :ios, '13.0'
          # ... existing Podfile content ...
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
                # Resolve GoogleUtilities conflict
                if target.name == 'GoogleUtilities'
                  config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
                  config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'DISABLE_FIREBASE_APPCHECK=1'
                end
              end
            end
          end
          EOF
        working-directory: mobileapp
      
      # Rebuild dependencies
      - run: flutter pub get
        working-directory: mobileapp
      
      # Pod setup
      - run: |
          cd ios
          pod install --repo-update
        working-directory: mobileapp
      
      # Build IPA
      - run: flutter build ios --release --no-codesign
        working-directory: mobileapp
      
      # Package IPA
      - name: Package IPA
        run: |
          cd mobileapp/build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload/
          zip -r FlutterIpaExport.ipa Payload
      
      # Upload artifact
      - name: Upload IPA
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mobileapp/build/ios/iphoneos/FlutterIpaExport.ipa
          asset_name: App-${{ github.run_number }}.ipa
          tag: ios-build-${{ github.run_number }}
          overwrite: true
