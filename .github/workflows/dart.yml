# .github/workflows/ios-build.yml
name: iOS-IPA-Build            # shows up in the Actions list

on:
  workflow_dispatch            # manual trigger

jobs:
  build-ios:
    runs-on: macos-latest      # Xcode 15 / Swift 5.9

    steps:
    # 1 â”€ Check out your code
    - uses: actions/checkout@v3

    # 2 â”€ Install Flutter (stable)
    - uses: subosito/flutter-action@v2
      with:
        channel: stable
        architecture: x64

    # 3 â”€ Clean project & fetch packages
    - name: Flutter clean / pub get
      run: |
        flutter clean
        flutter pub get
      working-directory: mobileapp

    # 4 â”€ Make sure iOS folder is fresh and targets iOS 13
    - name: Reset CocoaPods
      run: |
        cd ios
        rm -rf Pods Podfile.lock
        [ -f Podfile ] || pod init
        # Ensure the platform line is present and set to 13.0
        if grep -q "^platform :ios" Podfile; then
          sed -i '' "s/^platform :ios.*/platform :ios, '13.0'/" Podfile
        else
          sed -i '' '1s/^/platform :ios, '\''13.0'\''\n/' Podfile
        fi
      working-directory: mobileapp

    # 5 â”€ Force static frameworks + modular headers + Swift 5.9
    - name: Patch Podfile
      run: |
        cd mobileapp/ios

        # ----- Static linkage -----
        if grep -q "use_frameworks!" Podfile; then
          sed -i '' "s/use_frameworks!.*/use_frameworks! :linkage => :static/" Podfile
        else
          sed -i '' "/target 'Runner' do/a\\
  use_frameworks! :linkage => :static" Podfile
        fi

        # ----- Modular headers -----
        grep -q "use_modular_headers!" Podfile || \
          sed -i '' "/use_frameworks! :linkage => :static/a\\
  use_modular_headers!" Podfile

        # ----- Fresh post_install -----
        sed -i '' '/post_install do/,/^end$/d' Podfile
        printf "\npost_install do |installer|\n"           >> Podfile
        printf "  installer.pods_project.targets.each do |t|\n" >> Podfile
        printf "    t.build_configurations.each do |c|\n" >> Podfile
        printf "      c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'\n" >> Podfile
        printf "      c.build_settings['SWIFT_VERSION']              = '5.9'\n"  >> Podfile
        printf "    end\n"                                       >> Podfile
        printf "  end\nend\n"                                    >> Podfile

    # 6 â”€ Install pods
    - run: pod install --repo-update
      working-directory: mobileapp/ios

    # 7 â”€ Build an unsigned release
    - run: flutter build ios --release --no-codesign
      working-directory: mobileapp

    # 8 â”€ Package Runner.app â†’ IPA
    - name: Package IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        mv Runner.app Payload/
        zip -r FlutterIpaExport.ipa Payload
      working-directory: mobileapp

    # 9 â”€ Attach IPA to a GitHub Release
    - name: Upload IPA to GitHub Release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: mobileapp/build/ios/iphoneos/FlutterIpaExport.ipa
        asset_name: FlutterIpaExport.ipa
        tag: ios-build-${{ github.run_number }}
        overwrite: true
        body: |
          ðŸŽ‰ Unsigned iOS IPA for run #${{ github.run_number }}
