name: iOS-ipa-build
on:
  workflow_dispatch:
jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          architecture: x64
      
      - name: Set up environment
        run: |
          cd mobileapp
          flutter clean
          flutter pub get
      
      - name: Configure Podfile
        run: |
          cd mobileapp/ios
          # Ensure Podfile exists
          if [ ! -f Podfile ]; then
            pod init
          fi
          
          # Backup original Podfile
          cp Podfile Podfile.backup
          
          # Add platform and Firebase version constraints
          cat > Podfile << 'EOF'
          platform :ios, '13.0'
          $FirebaseSDKVersion = '10.20.0'
          
          # Original Podfile content
          $(tail -n +2 Podfile.backup)
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
                config.build_settings['SWIFT_VERSION'] = '5.0'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
              end
            end
          end
          EOF
      
      - name: Install pods
        run: |
          cd mobileapp/ios
          pod repo update
          pod install --repo-update
      
      - name: Build IPA
        run: |
          cd mobileapp
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload/
          zip -r FlutterIpaExport.ipa Payload
      
      - name: Upload IPA
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mobileapp/build/ios/iphoneos/FlutterIpaExport.ipa
          asset_name: AppName-${{ github.run_number }}.ipa
          tag: ios-build-${{ github.run_number }}
          overwrite: true
